<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Portf√≥lio de Investimentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  color:#333;
}
header {
  background:#1e293b;
  color:#fff;
  padding:16px;
  text-align:center;
}
.container {
  padding:16px;
  max-width:1200px;
  margin:auto;
}
.cards {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.card {
  background:#fff;
  padding:16px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}
.card h3 {
  margin:0 0 8px 0;
  font-size:14px;
  color:#555;
}
.card p {
  font-size:22px;
  font-weight:bold;
}
form {
  background:#fff;
  padding:16px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
  margin-bottom:24px;
}
form input, form select, form button {
  width:100%;
  padding:10px;
  margin:6px 0;
}
form button {
  background:#1e293b;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden;
}
th, td {
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:right;
}
th {
  background:#f1f5f9;
  text-align:right;
}
th:first-child, td:first-child { text-align:left; }
canvas { max-width:100%; }
</style>
</head>

<body>

<header>
<h1>üìä Portf√≥lio de Investimentos</h1>
</header>

<div class="container">

<form id="formOperacao">
<h3>Nova Opera√ß√£o</h3>
<input required placeholder="Ativo" id="ativo">
<select id="classe">
  <option>A√ß√µes</option>
  <option>Fundos Imobili√°rios</option>
  <option>Renda Fixa</option>
  <option>Internacional</option>
</select>
<select id="tipo">
  <option value="COMPRA">Compra</option>
  <option value="VENDA">Venda</option>
</select>
<input type="number" step="0.0001" placeholder="Quantidade" id="quantidade">
<input type="number" step="0.01" placeholder="Pre√ßo m√©dio atual (opcional)" id="preco">
<select id="moeda">
  <option>BRL</option>
  <option>USD</option>
</select>
<button type="submit">Salvar Opera√ß√£o</button>
</form>

<div class="cards">
  <div class="card"><h3>Patrim√¥nio Total</h3><p id="patrimonio">R$ 0,00</p></div>
  <div class="card"><h3>Lucro / Preju√≠zo</h3><p id="lucro">R$ 0,00</p></div>
  <div class="card"><h3>D√≥lar</h3><p id="usd">R$ 0,00</p></div>
</div>

<br>

<canvas id="grafico"></canvas>

<br>

<table id="tabela">
<thead>
<tr>
<th>Ativo</th><th>Classe</th><th>Qtd</th><th>PM</th><th>Pre√ßo Atual</th><th>Valor Atual</th><th>P/L</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const SHEET_ID = "COLE_AQUI_O_ID_DA_PLANILHA";
const WEBAPP_URL = "COLE_AQUI_A_URL_DO_WEBAPP";

const OPS_URL = `https://opensheet.elk.sh/${SHEET_ID}/OPERACOES`;
const COT_URL = `https://opensheet.elk.sh/${SHEET_ID}/COTACOES`;

document.getElementById("formOperacao").onsubmit = async e => {
  e.preventDefault();
  const tipo = tipoSelect.value;
  const qtd = parseFloat(quantidade.value) * (tipo === "VENDA" ? -1 : 1);

  await fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({
      data:new Date().toISOString().slice(0,10),
      ativo:ativo.value,
      classe:classe.value,
      quantidade:qtd,
      preco:preco.value || "",
      moeda:moeda.value
    })
  });
  alert("Opera√ß√£o salva!");
};

async function carregar(){
  const ops = await fetch(OPS_URL).then(r=>r.json());
  const cot = await fetch(COT_URL).then(r=>r.json());

  const usd = cot.find(c=>c.Ativo==="USD").Preco_Atual;
  document.getElementById("usd").innerText = `R$ ${usd}`;

  const mapa = {};
  ops.forEach(o=>{
    if(!mapa[o.Ativo]) mapa[o.Ativo]={...o,qtd:0,pm:0,total:0};
    if(o.Pre√ßo){
      mapa[o.Ativo].pm = parseFloat(o.Pre√ßo);
    }
    mapa[o.Ativo].qtd += parseFloat(o.Quantidade);
  });

  let patrimonio=0, lucro=0;
  const tbody=document.querySelector("tbody");
  tbody.innerHTML="";

  Object.values(mapa).forEach(a=>{
    const cotAtivo = cot.find(c=>c.Ativo===a.Ativo);
    if(!cotAtivo) return;
    let precoAtual = parseFloat(cotAtivo.Preco_Atual);
    if(a.Moeda==="USD") precoAtual*=usd;
    const valor = a.qtd * precoAtual;
    const pl = valor - (a.qtd * a.pm);
    patrimonio+=valor; lucro+=pl;

    tbody.innerHTML+=`
    <tr>
      <td>${a.Ativo}</td><td>${a.Classe}</td><td>${a.qtd}</td>
      <td>${a.pm.toFixed(2)}</td><td>${precoAtual.toFixed(2)}</td>
      <td>${valor.toFixed(2)}</td><td>${pl.toFixed(2)}</td>
    </tr>`;
  });

  patrimonioEl.innerText=`R$ ${patrimonio.toFixed(2)}`;
  lucroEl.innerText=`R$ ${lucro.toFixed(2)}`;
}

carregar();
</script>

</body>
</html>
