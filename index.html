<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PortfÃ³lio Financeiro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; font-family:Inter,Arial; background:#f3f4f6 }
header { background:#0f172a; color:#fff; padding:18px; font-size:20px }
.container { max-width:1200px; margin:auto; padding:20px }
.card { background:#fff; border-radius:14px; padding:18px; margin-bottom:20px; box-shadow:0 6px 16px rgba(0,0,0,.08) }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px }
input,select,button { padding:10px; border-radius:8px; border:1px solid #ccc; width:100% }
button { background:#2563eb; color:#fff; font-weight:600; cursor:pointer }
table { width:100%; border-collapse:collapse }
th,td { padding:10px; border-bottom:1px solid #e5e7eb; text-align:center }
th { background:#f9fafb }
.pos { color:#16a34a }
.neg { color:#dc2626 }
.badge { background:#e5e7eb; padding:5px 10px; border-radius:999px; font-size:13px }
small { color:#6b7280 }
</style>
</head>

<body>
<header>ðŸ“Š PortfÃ³lio Financeiro</header>
<div class="container">

<!-- NOVA OPERAÃ‡ÃƒO -->
<div class="card">
<h3>âž• Nova OperaÃ§Ã£o</h3>
<small>
â€¢ Use <b>PreÃ§o mÃ©dio atual</b> apenas se vocÃª jÃ¡ possui o ativo<br>
â€¢ Compras novas deixam o campo vazio<br>
â€¢ Vendas nÃ£o usam preÃ§o
</small>
<br><br>
<div class="grid">
<input id="ativo" placeholder="Ativo (TAEE4, AAPL)">
<select id="classe">
<option>AÃ§Ãµes</option>
<option>Fundos ImobiliÃ¡rios</option>
<option>Renda Fixa</option>
<option>Internacional</option>
</select>
<select id="tipo">
<option value="compra">Compra</option>
<option value="venda">Venda</option>
</select>
<input id="quantidade" type="number" placeholder="Quantidade">
<input id="preco" type="number" placeholder="PreÃ§o mÃ©dio atual (opcional)">
<select id="moeda">
<option>BRL</option>
<option>USD</option>
</select>
</div><br>
<button onclick="salvar()">Salvar</button>
</div>

<!-- RESUMO -->
<div class="grid">
<div class="card"><h4>ðŸ’° PatrimÃ´nio</h4><h2 id="patrimonio">R$ 0</h2></div>
<div class="card"><h4>ðŸ“ˆ Resultado</h4><h2 id="resultado">R$ 0</h2></div>
<div class="card"><h4>ðŸ’µ DÃ³lar</h4><h2 id="dolar">R$ 0</h2></div>
</div>

<!-- GRAFICO -->
<div class="card">
<canvas id="grafico"></canvas>
</div>

<!-- APORTE -->
<div class="card">
<h3>ðŸŽ¯ SugestÃ£o de Aporte</h3>
<div id="aporte"></div>
</div>

<!-- POSICOES -->
<div class="card">
<h3>ðŸ“‹ PosiÃ§Ãµes</h3>
<table>
<thead>
<tr>
<th>Ativo</th>
<th>Classe</th>
<th>Qtd</th>
<th>PreÃ§o MÃ©dio</th>
<th>PreÃ§o Atual</th>
<th>Valor Atual</th>
<th>Resultado</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>
</div>

</div>

<script>
const SHEET_ID = "SUA_PLANILHA_ID";
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz8iTXCb1r3PVQRx4wjSsvJufh5SH4WLhU4hRC3UHoCsAWtV1ClBXrEfSMZ45yS8h9QRw/exec";
const BASE = `https://opensheet.elk.sh/${SHEET_ID}/`;

let cotacoes = {}, dolar = 1;

async function carregar() {
  const ops = await fetch(BASE+"OPERACOES").then(r=>r.json());
  const cots = await fetch(BASE+"COTACOES").then(r=>r.json());

  cots.forEach(c=>{
    cotacoes[c.Ativo] = Number(c.Preco_Atual);
    if(c.Ativo === "USD") dolar = Number(c.Preco_Atual);
  });

  document.getElementById("dolar").innerText = `R$ ${dolar.toFixed(2)}`;
  processar(ops);
}

function processar(ops){
  const ativos = {};
  const porClasse = {};
  let patrimonio = 0, resultado = 0;

  ops.forEach(o=>{
    const q = Number(o.Quantidade);
    if(!ativos[o.Ativo]){
      ativos[o.Ativo] = {
        Ativo:o.Ativo,
        Classe:o.Classe,
        Moeda:o.Moeda,
        qtd:0,
        custo:0
      };
    }

    if(q > 0 && o.PreÃ§o){
      ativos[o.Ativo].custo += q * Number(o.PreÃ§o);
    }

    ativos[o.Ativo].qtd += q;
  });

  const tb = document.getElementById("tabela");
  tb.innerHTML = "";

  Object.values(ativos).forEach(a=>{
    if(a.qtd <= 0) return;

    const pm = a.custo / a.qtd;
    const precoAtual = cotacoes[a.Ativo] || 0;

    let valorAtual = precoAtual * a.qtd;
    if(a.Moeda === "USD") valorAtual *= dolar;

    const res = valorAtual - (pm * a.qtd);

    patrimonio += valorAtual;
    resultado += res;
    porClasse[a.Classe] = (porClasse[a.Classe] || 0) + valorAtual;

    tb.innerHTML += `
      <tr>
        <td>${a.Ativo}</td>
        <td><span class="badge">${a.Classe}</span></td>
        <td>${a.qtd}</td>
        <td>${pm.toFixed(2)}</td>
        <td>${precoAtual.toFixed(2)}</td>
        <td>R$ ${valorAtual.toFixed(2)}</td>
        <td class="${res>=0?'pos':'neg'}">R$ ${res.toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById("patrimonio").innerText = `R$ ${patrimonio.toFixed(2)}`;
  document.getElementById("resultado").innerText = `R$ ${resultado.toFixed(2)}`;

  new Chart(document.getElementById("grafico"),{
    type:"doughnut",
    data:{
      labels:Object.keys(porClasse),
      datasets:[{ data:Object.values(porClasse) }]
    }
  });

  const alvo = patrimonio / Object.keys(porClasse).length;
  let html = "";
  Object.entries(porClasse).forEach(([c,v])=>{
    if(v < alvo){
      html += `ðŸ“Œ ${c}: aportar R$ ${(alvo - v).toFixed(2)}<br>`;
    }
  });

  document.getElementById("aporte").innerHTML =
    html || "âœ” PortfÃ³lio balanceado";
}

async function salvar(){
  let q = Number(quantidade.value);
  if(tipo.value === "venda") q = -Math.abs(q);

  await fetch(WEBAPP_URL,{
    method:"POST",
    body: JSON.stringify({
      ativo: ativo.value.toUpperCase(),
      classe: classe.value,
      quantidade: q,
      preco: preco.value,
      moeda: moeda.value
    })
  });

  alert("OperaÃ§Ã£o salva com sucesso!");
  carregar();
}

carregar();
</script>
</body>
</html>
