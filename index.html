<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PortfÃ³lio Financeiro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; font-family:Inter,Arial; background:#f4f6fa }
header { background:#111827; color:#fff; padding:18px; font-size:20px }
.container { padding:20px; max-width:1200px; margin:auto }
.card { background:#fff; border-radius:14px; padding:18px; margin-bottom:20px; box-shadow:0 6px 18px rgba(0,0,0,.08) }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:15px }
input,select,button { padding:10px; border-radius:8px; border:1px solid #ccc; width:100% }
button { background:#2563eb; color:#fff; font-weight:600; cursor:pointer }
table { width:100%; border-collapse:collapse }
th,td { padding:10px; border-bottom:1px solid #e5e7eb; text-align:center }
th { background:#f9fafb }
.pos { color:#16a34a }
.neg { color:#dc2626 }
.badge { padding:6px 10px; border-radius:999px; background:#e5e7eb; font-size:13px }
</style>
</head>

<body>
<header>ðŸ“Š PortfÃ³lio Financeiro</header>

<div class="container">

<!-- NOVA OPERAÃ‡ÃƒO -->
<div class="card">
<h3>âž• Nova OperaÃ§Ã£o</h3>
<div class="grid">
<input id="ativo" placeholder="Ativo (TAEE4, AAPL)">
<select id="classe">
<option>AÃ§Ãµes</option>
<option>Fundos ImobiliÃ¡rios</option>
<option>Renda Fixa</option>
<option>Internacional</option>
</select>
<select id="tipo">
<option value="compra">Compra</option>
<option value="venda">Venda</option>
</select>
<input id="quantidade" type="number" placeholder="Quantidade">
<input id="preco" type="number" placeholder="PreÃ§o (sÃ³ 1Âª compra)">
<select id="moeda">
<option>BRL</option>
<option>USD</option>
</select>
</div>
<br>
<button onclick="salvar()">Salvar</button>
</div>

<!-- RESUMO -->
<div class="grid">
<div class="card"><h4>ðŸ’° PatrimÃ´nio</h4><h2 id="patrimonio">R$ 0</h2></div>
<div class="card"><h4>ðŸ“ˆ Resultado</h4><h2 id="resultado">R$ 0</h2></div>
<div class="card"><h4>ðŸ’µ DÃ³lar</h4><h2 id="dolar">R$ 0</h2></div>
</div>

<!-- DASHBOARD -->
<div class="card">
<canvas id="grafico"></canvas>
</div>

<!-- APORTE -->
<div class="card">
<h3>ðŸŽ¯ SugestÃ£o de Aporte</h3>
<div id="aporte"></div>
</div>

<!-- POSIÃ‡Ã•ES -->
<div class="card">
<h3>ðŸ“‹ PosiÃ§Ãµes</h3>
<table>
<thead>
<tr>
<th>Ativo</th>
<th>Classe</th>
<th>Qtd</th>
<th>PreÃ§o MÃ©dio</th>
<th>PreÃ§o Atual</th>
<th>Valor Atual</th>
<th>Resultado</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>
</div>

</div>

<script>
const SHEET_ID = "SUA_PLANILHA_ID";
const BASE = `https://opensheet.elk.sh/${SHEET_ID}/`;

let cotacoes = {};
let dolar = 1;

async function carregar() {
  const operacoes = await fetch(BASE+"OPERACOES").then(r=>r.json());
  const cots = await fetch(BASE+"COTACOES").then(r=>r.json());

  cots.forEach(c=>{
    cotacoes[c.Ativo] = Number(c.Preco_Atual);
    if(c.Ativo === "USD") dolar = Number(c.Preco_Atual);
  });

  document.getElementById("dolar").innerText = `R$ ${dolar.toFixed(2)}`;

  processar(operacoes);
}

function processar(ops) {
  const ativos = {};
  ops.forEach(o=>{
    const qtd = Number(o.Quantidade);
    if(!ativos[o.Ativo]) {
      ativos[o.Ativo] = {
        ativo:o.Ativo, classe:o.Classe, moeda:o.Moeda,
        qtd:0, custo:0
      };
    }
    if(qtd > 0) ativos[o.Ativo].custo += qtd * (Number(o.PreÃ§o)||0);
    ativos[o.Ativo].qtd += qtd;
  });

  let patrimonio = 0, resultado = 0;
  let porClasse = {};
  const tbody = document.getElementById("tabela");
  tbody.innerHTML = "";

  Object.values(ativos).forEach(a=>{
    if(a.qtd <= 0) return;
    const pm = a.custo / a.qtd;
    const precoAtual = cotacoes[a.ativo] || 0;
    let valorAtual = precoAtual * a.qtd;
    if(a.moeda === "USD") valorAtual *= dolar;

    const custoTotal = pm * a.qtd;
    const res = valorAtual - custoTotal;

    patrimonio += valorAtual;
    resultado += res;
    porClasse[a.classe] = (porClasse[a.classe]||0) + valorAtual;

    tbody.innerHTML += `
      <tr>
        <td>${a.ativo}</td>
        <td><span class="badge">${a.classe}</span></td>
        <td>${a.qtd}</td>
        <td>${pm.toFixed(2)}</td>
        <td>${precoAtual.toFixed(2)}</td>
        <td>R$ ${valorAtual.toFixed(2)}</td>
        <td class="${res>=0?'pos':'neg'}">R$ ${res.toFixed(2)}</td>
      </tr>
    `;
  });

  document.getElementById("patrimonio").innerText = `R$ ${patrimonio.toFixed(2)}`;
  document.getElementById("resultado").innerText = `R$ ${resultado.toFixed(2)}`;

  grafico(porClasse);
  sugestao(porClasse, patrimonio);
}

function grafico(dados) {
  const ctx = document.getElementById("grafico");
  new Chart(ctx,{
    type:'doughnut',
    data:{ labels:Object.keys(dados),
      datasets:[{ data:Object.values(dados) }]
    }
  });
}

function sugestao(dados,total){
  const alvo = total / Object.keys(dados).length;
  let html="";
  Object.entries(dados).forEach(([c,v])=>{
    if(v < alvo){
      html += `ðŸ“Œ ${c}: aportar R$ ${(alvo-v).toFixed(2)}<br>`;
    }
  });
  document.getElementById("aporte").innerHTML = html || "âœ” PortfÃ³lio balanceado";
}

async function salvar(){
  alert("Para salvar direto na planilha use Google Apps Script WebApp (prÃ³ximo passo).");
}

carregar();
</script>

</body>
</html>
